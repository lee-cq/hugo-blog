<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级多队列倒计时工具</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        danger: '#EF4444',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-md;
            }
            .btn-effect {
                @apply transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-dark p-4 md:p-6">
    <div class="max-w-4xl mx-auto">
        <!-- 标题区域 -->
        <header class="text-center mb-6 md:mb-8">
            <h1 class="text-2xl md:text-3xl font-bold mb-2 flex items-center justify-center">
                <i class="fa fa-clock-o text-primary mr-2"></i>多队列倒计时工具
            </h1>
            <p class="text-gray-600">高效管理多个倒计时任务，不错过任何重要时刻</p>
            
            <!-- 通知权限提示 -->
            <div id="notificationPermission" class="mt-4 hidden">
                <button id="requestNotificationBtn" class="px-4 py-2 border border-gray-300 rounded-md text-sm btn-effect hover:bg-gray-50">
                    <i class="fa fa-bell-o mr-1"></i>启用通知提醒
                </button>
            </div>
        </header>
        
        <!-- 主内容区域 -->
        <main>
            <!-- 添加倒计时按钮 -->
            <div class="text-center mb-6">
                <button id="addCountdownBtn" class="px-5 py-2 bg-primary text-white rounded-md font-medium btn-effect hover:bg-primary/90 focus:ring-primary/50">
                    <i class="fa fa-plus mr-2"></i>添加新倒计时
                </button>
            </div>
            
            <!-- 倒计时列表 -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold mb-3 flex items-center">
                    <i class="fa fa-list-alt text-primary mr-2"></i>当前倒计时
                </h2>
                <div id="countdownList" class="space-y-3">
                    <!-- 倒计时项将通过JavaScript动态添加 -->
                    <div class="text-center text-gray-500 py-10" id="emptyState">
                        <i class="fa fa-hourglass-o text-4xl mb-3 opacity-30"></i>
                        <p>还没有倒计时任务，点击上方按钮添加一个吧</p>
                    </div>
                </div>
            </div>
            
            <!-- 历史记录区域 -->
            <div>
                <h2 class="text-lg font-semibold mb-3 flex items-center">
                    <i class="fa fa-history text-gray-500 mr-2"></i>历史记录
                </h2>
                <div id="historyList" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                    <!-- 历史记录项将通过JavaScript动态添加 -->
                    <div class="text-center text-gray-500 py-6" id="historyEmptyState">
                        <p class="text-sm">暂无历史记录</p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 页脚 -->
        <footer class="mt-10 text-center text-gray-500 text-sm">
            <p>倒计时工具 &copy; 2023</p>
        </footer>
    </div>
    
    <!-- 添加倒计时的模态框 -->
    <div id="addModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-5 md:p-6 transform transition-all scale-95 opacity-0" id="modalContent">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fa fa-plus-circle text-primary mr-2"></i>
                <span id="modalTitle">添加倒计时</span>
            </h2>
            
            <!-- 关键修复：将div改为form元素 -->
            <form id="addForm" class="space-y-4">
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">描述</label>
                    <input 
                        type="text" 
                        id="description" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        placeholder="例如：会议开始"
                        required
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">倒计时时间</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <input 
                                type="number" 
                                id="hours" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="时"
                                min="0"
                                value="0"
                            >
                        </div>
                        <div>
                            <input 
                                type="number" 
                                id="minutes" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="分"
                                min="0"
                                max="59"
                                value="0"
                            >
                        </div>
                        <div>
                            <input 
                                type="number" 
                                id="seconds" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="秒"
                                min="1"
                                max="59"
                                value="10"
                            >
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 btn-effect">
                        取消
                    </button>
                    <button type="button" id="confirmBtn" class="px-4 py-2 bg-primary text-white rounded-md font-medium btn-effect hover:bg-primary/90 focus:ring-primary/50">
                        确认添加
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 倒计时项类
        class CountdownItem {
            constructor(id, description, totalSeconds, remainingSeconds = null, startTime = null, completionTime = null, isNew = true) {
                this.id = id;
                this.description = description;
                this.totalSeconds = totalSeconds;
                this.remainingSeconds = remainingSeconds !== null ? remainingSeconds : totalSeconds;
                this.startTime = startTime || new Date().toISOString();
                this.completionTime = completionTime; // 新增：记录完成时间
                this.running = true;
                this.element = null;
                this.timer = null;
                
                // 如果是从存储加载的，需要重新启动计时器
                if (!isNew && this.remainingSeconds > 0) {
                    this.start();
                } else if (this.remainingSeconds <= 0) {
                    this.running = false;
                }
            }
            
            // 格式化剩余时间为 HH:MM:SS
            formatTime() {
                const hours = Math.floor(this.remainingSeconds / 3600);
                const minutes = Math.floor((this.remainingSeconds % 3600) / 60);
                const seconds = this.remainingSeconds % 60;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // 格式化总时间（用于历史记录）
            formatTotalTime() {
                const hours = Math.floor(this.totalSeconds / 3600);
                const minutes = Math.floor((this.totalSeconds % 3600) / 60);
                const seconds = this.totalSeconds % 60;
                
                let parts = [];
                if (hours > 0) parts.push(`${hours}小时`);
                if (minutes > 0) parts.push(`${minutes}分钟`);
                if (seconds > 0) parts.push(`${seconds}秒`);
                
                return parts.join('');
            }
            
            // 格式化剩余时间（用于历史记录）
            formatRemainingTime() {
                const hours = Math.floor(this.remainingSeconds / 3600);
                const minutes = Math.floor((this.remainingSeconds % 3600) / 60);
                const seconds = this.remainingSeconds % 60;
                
                let parts = [];
                if (hours > 0) parts.push(`${hours}小时`);
                if (minutes > 0) parts.push(`${minutes}分钟`);
                if (seconds > 0) parts.push(`${seconds}秒`);
                
                return parts.join('');
            }
            
            // 格式化日期时间
            formatDateTime(timestamp) {
                const date = new Date(timestamp);
                return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
            }
            
            // 创建DOM元素
            createElement() {
                const item = document.createElement('div');
                item.className = 'bg-white rounded-lg shadow-sm p-4 flex items-center justify-between card-hover';
                item.dataset.id = this.id;
                
                // 基础HTML结构
                let buttonHtml = `
                    <button class="delete-btn px-3 py-1.5 bg-danger text-white rounded-md text-sm btn-effect hover:bg-danger/90 focus:ring-danger/50" data-remove>
                        <i class="fa fa-trash-o mr-1"></i>删除
                    </button>
                `;
                
                // 如果已经完成，显示不同样式
                if (this.remainingSeconds <= 0) {
                    buttonHtml = `
                        <button class="complete-btn px-3 py-1.5 bg-success text-white rounded-md text-sm btn-effect hover:bg-success/90 focus:ring-success/50" data-remove>
                            <i class="fa fa-check mr-1"></i>完成
                        </button>
                    `;
                }
                
                item.innerHTML = `
                    <div class="flex-1 min-w-0 mr-4">
                        <div class="font-medium truncate">${this.description}</div>
                        <div class="time-display font-mono text-primary mt-1" data-time>${this.formatTime()}</div>
                    </div>
                    ${buttonHtml}
                `;
                
                // 如果已经完成，更新样式
                if (this.remainingSeconds <= 0) {
                    const timeElement = item.querySelector('[data-time]');
                    timeElement.classList.add('text-success', 'font-bold');
                }
                
                // 存储时间显示元素的引用
                this.timeElement = item.querySelector('[data-time]');
                this.actionButton = item.querySelector('[data-remove]');
                
                // 添加删除事件监听
                this.actionButton.addEventListener('click', () => {
                    this.moveToHistory();
                });
                
                this.element = item;
                return item;
            }
            
            // 开始倒计时
            start() {
                if (this.timer) clearInterval(this.timer);
                
                this.timer = setInterval(() => {
                    if (this.running && this.remainingSeconds > 0) {
                        this.remainingSeconds--;
                        this.timeElement.textContent = this.formatTime();
                        
                        // 保存更新后的状态
                        saveData();
                    } else if (this.remainingSeconds <= 0) {
                        this.complete();
                    }
                }, 1000);
            }
            
            // 倒计时完成
            complete() {
                clearInterval(this.timer);
                this.timeElement.textContent = '00:00:00';
                this.timeElement.classList.add('text-success', 'font-bold');
                this.running = false;
                
                // 关键修复：记录完成时间
                this.completionTime = new Date().toISOString();
                
                // 更新按钮为完成状态
                this.actionButton.innerHTML = '<i class="fa fa-check mr-1"></i>完成';
                this.actionButton.className = 'complete-btn px-3 py-1.5 bg-success text-white rounded-md text-sm btn-effect hover:bg-success/90 focus:ring-success/50';
                
                // 尝试发送通知
                this.showNotification();
                
                // 保存状态
                saveData();
            }
            
            // 显示通知
            showNotification() {
                // 检查浏览器是否支持通知
                if (Notification.permission === 'granted') {
                    new Notification('倒计时完成', {
                        body: `${this.description} 已经完成了！`,
                        icon: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMTBCOTgxIiBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptMCA0MzJoLTMyVjM4NGgtMzJ2LTQwSDI1NnYzOGgtMzJ2NDB6bTMyLTEyOEg4OFYxMkg0MjRWNDgwIi8+PC9zdmc+'
                    });
                } else {
                    // 通知未授权时，显示视觉提示
                    this.element.classList.add('bg-green-50');
                    setTimeout(() => {
                        this.element.classList.remove('bg-green-50');
                    }, 2000);
                    
                    // 显示授权提示按钮
                    document.getElementById('notificationPermission').classList.remove('hidden');
                }
            }
            
            // 移到历史记录
            moveToHistory() {
                this.running = false;
                clearInterval(this.timer);
                
                // 从当前列表移除
                if (this.element && this.element.parentNode) {
                    this.element.remove();
                }
                
                // 从倒计时列表中移除
                const index = countdowns.findIndex(item => item.id === this.id);
                if (index !== -1) {
                    countdowns.splice(index, 1);
                }
                
                // 添加到历史记录（判断是否完成）
                const isCompleted = this.remainingSeconds <= 0;
                addToHistory(this, isCompleted);
                
                // 更新UI状态
                checkEmptyState();
                saveData();
            }
            
            // 转换为可存储的对象
            toStorageObject() {
                return {
                    id: this.id,
                    description: this.description,
                    totalSeconds: this.totalSeconds,
                    remainingSeconds: this.remainingSeconds,
                    startTime: this.startTime,
                    completionTime: this.completionTime, // 保存完成时间
                    running: this.running
                };
            }
        }
        
        // 历史记录项类
        class HistoryItem {
            constructor(countdownItem, isCompleted) {
                this.id = countdownItem.id;
                this.description = countdownItem.description;
                this.totalSeconds = countdownItem.totalSeconds;
                this.totalTime = countdownItem.formatTotalTime();
                this.startTime = countdownItem.startTime;
                // 关键修复：使用倒计时完成时间作为结束时间
                this.endTime = isCompleted ? countdownItem.completionTime : new Date().toISOString();
                this.isCompleted = isCompleted;
                this.remainingSeconds = countdownItem.remainingSeconds;
                this.remainingTime = countdownItem.formatRemainingTime();
                this.element = null;
            }
            
            // 创建DOM元素
            createElement() {
                const item = document.createElement('div');
                const statusClass = this.isCompleted ? 'border-l-4 border-success' : 'border-l-4 border-danger';
                const statusIcon = this.isCompleted ? 'fa-check-circle text-success' : 'fa-times-circle text-danger';
                
                // 格式化日期显示
                const formatDateTime = (timestamp) => {
                    const date = new Date(timestamp);
                    return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
                };
                
                // 时间信息
                let timeInfo = '';
                if (this.isCompleted) {
                    timeInfo = `
                        <div class="text-sm mt-1">
                            <span>持续时间: ${this.totalTime}</span> | 
                            <span>开始: ${formatDateTime(this.startTime)}</span> | 
                            <span>完成: ${formatDateTime(this.endTime)}</span>
                        </div>
                    `;
                } else {
                    timeInfo = `
                        <div class="text-sm mt-1">
                            <span>指定时长: ${this.totalTime} (剩余: ${this.remainingTime})</span> | 
                            <span>开始: ${formatDateTime(this.startTime)}</span> | 
                            <span>删除: ${formatDateTime(this.endTime)}</span>
                        </div>
                    `;
                }
                
                item.className = `pl-3 py-2 bg-gray-50 rounded-r-md flex items-center justify-between cursor-pointer card-hover ${statusClass}`;
                item.dataset.id = this.id;
                
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="font-medium truncate flex items-center">
                            <i class="fa ${statusIcon} mr-2"></i>
                            ${this.description}
                        </div>
                        ${timeInfo}
                    </div>
                    <button class="delete-history-btn text-gray-400 hover:text-danger p-2" data-delete-history>
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                // 添加点击事件（重新添加为新倒计时）
                item.addEventListener('click', (e) => {
                    // 如果点击的是删除按钮，不触发重新添加
                    if (!e.target.closest('[data-delete-history]')) {
                        this.reAddCountdown();
                    }
                });
                
                // 添加删除事件监听
                item.querySelector('[data-delete-history]').addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止触发卡片点击事件
                    this.remove();
                });
                
                this.element = item;
                return item;
            }
            
            // 重新添加为新倒计时
            reAddCountdown() {
                // 计算小时、分钟、秒
                const hours = Math.floor(this.totalSeconds / 3600);
                const minutes = Math.floor((this.totalSeconds % 3600) / 60);
                const seconds = this.totalSeconds % 60;
                
                // 填充表单
                document.getElementById('description').value = this.description;
                document.getElementById('hours').value = hours;
                document.getElementById('minutes').value = minutes;
                document.getElementById('seconds').value = seconds;
                document.getElementById('modalTitle').textContent = '重新添加倒计时';
                
                // 显示模态框
                showModal();
            }
            
            // 从历史记录中移除
            remove() {
                if (this.element && this.element.parentNode) {
                    this.element.remove();
                }
                
                // 从历史记录列表中移除
                const index = historyItems.findIndex(item => item.id === this.id);
                if (index !== -1) {
                    historyItems.splice(index, 1);
                }
                
                // 检查历史记录空状态
                checkHistoryEmptyState();
                saveData();
            }
            
            // 转换为可存储的对象
            toStorageObject() {
                return {
                    id: this.id,
                    description: this.description,
                    totalSeconds: this.totalSeconds,
                    totalTime: this.totalTime,
                    startTime: this.startTime,
                    endTime: this.endTime,
                    isCompleted: this.isCompleted,
                    remainingSeconds: this.remainingSeconds,
                    remainingTime: this.remainingTime
                };
            }
        }
        
        // 全局变量
        let countdowns = [];
        let historyItems = [];
        let nextId = 1;
        const countdownList = document.getElementById('countdownList');
        const historyList = document.getElementById('historyList');
        const emptyState = document.getElementById('emptyState');
        const historyEmptyState = document.getElementById('historyEmptyState');
        const addCountdownBtn = document.getElementById('addCountdownBtn');
        const addModal = document.getElementById('addModal');
        const modalContent = document.getElementById('modalContent');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        const requestNotificationBtn = document.getElementById('requestNotificationBtn');
        const modalTitle = document.getElementById('modalTitle');
        
        // 检查是否为空状态
        function checkEmptyState() {
            if (countdowns.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }
        }
        
        // 检查历史记录是否为空
        function checkHistoryEmptyState() {
            if (historyItems.length === 0) {
                historyEmptyState.classList.remove('hidden');
            } else {
                historyEmptyState.classList.add('hidden');
            }
        }
        
        // 显示模态框
        function showModal() {
            addModal.classList.remove('hidden');
            // 触发动画
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.getElementById('description').focus();
        }
        
        // 隐藏模态框
        function hideModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                addModal.classList.add('hidden');
                // 重置表单值和标题
                document.getElementById('addForm').reset();
                document.getElementById('seconds').value = 10;
                modalTitle.textContent = '添加倒计时';
            }, 300);
        }
        
        // 添加新倒计时
        function addCountdown(description, hours, minutes, seconds) {
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            
            if (totalSeconds <= 0) {
                alert('请输入有效的倒计时时间');
                return false;
            }
            
            const countdown = new CountdownItem(nextId++, description, totalSeconds);
            countdowns.push(countdown);
            
            // 添加到DOM
            const element = countdown.createElement();
            countdownList.appendChild(element);
            
            // 开始倒计时
            countdown.start();
            
            // 检查空状态
            checkEmptyState();
            
            // 保存数据
            saveData();
            
            return true;
        }
        
        // 添加到历史记录
        function addToHistory(countdownItem, isCompleted) {
            const historyItem = new HistoryItem(countdownItem, isCompleted);
            historyItems.push(historyItem);
            
            // 添加到DOM（添加到最前面）
            const element = historyItem.createElement();
            if (historyList.firstChild) {
                historyList.insertBefore(element, historyList.firstChild);
            } else {
                historyList.appendChild(element);
            }
            
            // 检查历史记录空状态
            checkHistoryEmptyState();
        }
        
        // 保存数据到localStorage
        function saveData() {
            // 转换为可存储的格式
            const countdownData = countdowns.map(item => item.toStorageObject());
            const historyData = historyItems.map(item => item.toStorageObject());
            
            // 保存到localStorage
            localStorage.setItem('countdowns', JSON.stringify(countdownData));
            localStorage.setItem('historyItems', JSON.stringify(historyData));
            localStorage.setItem('nextId', nextId.toString());
        }
        
        // 从localStorage加载数据
        function loadData() {
            // 加载倒计时
            const countdownData = localStorage.getItem('countdowns');
            if (countdownData) {
                try {
                    const parsedData = JSON.parse(countdownData);
                    countdowns = parsedData.map(item => 
                        new CountdownItem(
                            item.id, 
                            item.description, 
                            item.totalSeconds, 
                            item.remainingSeconds,
                            item.startTime,
                            item.completionTime, // 加载完成时间
                            false
                        )
                    );
                    
                    // 重新创建DOM元素
                    countdowns.forEach(item => {
                        const element = item.createElement();
                        countdownList.appendChild(element);
                    });
                } catch (e) {
                    console.error('加载倒计时数据失败:', e);
                    localStorage.removeItem('countdowns');
                }
            }
            
            // 加载历史记录
            const historyData = localStorage.getItem('historyItems');
            if (historyData) {
                try {
                    const parsedData = JSON.parse(historyData);
                    historyItems = parsedData.map(item => {
                        const historyItem = new HistoryItem({
                            id: item.id,
                            description: item.description,
                            totalSeconds: item.totalSeconds,
                            formatTotalTime: () => item.totalTime,
                            startTime: item.startTime,
                            completionTime: item.completionTime, // 加载完成时间
                            remainingSeconds: item.remainingSeconds,
                            formatRemainingTime: () => item.remainingTime
                        }, item.isCompleted);
                        historyItem.endTime = item.endTime;
                        return historyItem;
                    });
                    
                    // 重新创建DOM元素（保持顺序）
                    historyItems.slice().reverse().forEach(item => {
                        const element = item.createElement();
                        historyList.appendChild(element);
                    });
                } catch (e) {
                    console.error('加载历史记录数据失败:', e);
                    localStorage.removeItem('historyItems');
                }
            }
            
            // 加载nextId
            const nextIdStr = localStorage.getItem('nextId');
            if (nextIdStr) {
                nextId = parseInt(nextIdStr);
            }
            
            // 检查空状态
            checkEmptyState();
            checkHistoryEmptyState();
        }
        
        // 事件监听
        addCountdownBtn.addEventListener('click', () => {
            // 重置表单并显示模态框
            document.getElementById('addForm').reset();
            document.getElementById('seconds').value = 10;
            modalTitle.textContent = '添加倒计时';
            showModal();
        });
        
        cancelBtn.addEventListener('click', hideModal);
        
        addModal.addEventListener('click', (e) => {
            if (e.target === addModal) {
                hideModal();
            }
        });
        
        // 确认添加倒计时
        confirmBtn.addEventListener('click', () => {
            const description = document.getElementById('description').value.trim() || 
                               `倒计时 #${nextId}`;
            const hours = parseInt(document.getElementById('hours').value) || 0;
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            
            if (addCountdown(description, hours, minutes, seconds)) {
                hideModal();
            }
        });
        
        // 支持按Enter键提交
        document.getElementById('addForm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                confirmBtn.click();
            }
        });
        
        // 请求通知权限
        requestNotificationBtn.addEventListener('click', () => {
            if (Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        alert('通知权限已启用，倒计时完成时将收到通知');
                        document.getElementById('notificationPermission').classList.add('hidden');
                    } else {
                        alert('通知权限被拒绝，您将不会收到通知提醒');
                    }
                });
            }
        });
        
        // 初始化
        function init() {
            // 检查通知权限状态
            if (Notification.permission !== 'granted') {
                document.getElementById('notificationPermission').classList.remove('hidden');
            }
            
            // 从存储加载数据
            loadData();
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
